name: トレンド記事自動生成・投稿（2時間おき）

on:
  schedule:
    # JST 5時から25時（1時）まで2時間おきに実行
    # UTC時間で20時から16時まで（JST = UTC + 9時間）
    # 20時(JST 5時), 22時(JST 7時), 0時(JST 9時), 2時(JST 11時), 4時(JST 13時), 
    # 6時(JST 15時), 8時(JST 17時), 10時(JST 19時), 12時(JST 21時), 14時(JST 23時), 16時(JST 1時)
    - cron: '0 20,22,0,2,4,6,8,10,12,14,16 * * *'
  workflow_dispatch: {}

jobs:
  generate-trend-article:
    runs-on: ubuntu-latest
    
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: Checkout note-auto-core
        uses: actions/checkout@v4
        with:
          repository: aa-0921/note-auto-core
          path: note-auto-core
          ref: main
          token: ${{ secrets.CORE_REPO_TOKEN }}
      
      - name: Node.jsのセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: 依存関係のインストール
        run: |
          # note-auto-coreの依存関係をインストール
          cd note-auto-core && npm install
          cd ..
          # ローカルパッケージを直接参照してインストール
          npm install ./note-auto-core
      
      - name: Chromiumのインストール
        run: |
          npx puppeteer browsers install chrome
      
      - name: トレンド記事を生成・投稿
        env:
          NOTE_EMAIL: ${{ secrets.NOTE_EMAIL }}
          NOTE_PASSWORD: ${{ secrets.NOTE_PASSWORD }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          node scripts/generateTrendArticle.js --bg
      
      - name: エラー時の通知（オプション）
        if: failure()
        run: |
          echo "トレンド記事の生成・投稿に失敗しました"
          # Slack通知などを追加することもできます
