name: ニュース記事自動生成・投稿（2時間おき）

on:
  schedule:
    # JST 6時から24時（0時）まで2時間おきに実行（1時間ずらして）
    # UTC時間で21時から15時まで（JST = UTC + 9時間）
    # 21時(JST 6時), 23時(JST 8時), 1時(JST 10時), 3時(JST 12時), 5時(JST 14時), 
    # 7時(JST 16時), 9時(JST 18時), 11時(JST 20時), 13時(JST 22時), 15時(JST 24時/0時)
    - cron: '0 21,23,1,3,5,7,9,11,13,15 * * *'
  workflow_dispatch: {}

jobs:
  generate-ynews-article:
    runs-on: ubuntu-latest
    
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: Checkout note-auto-core
        uses: actions/checkout@v4
        with:
          repository: aa-0921/note-auto-core
          path: note-auto-core
          ref: main
          token: ${{ secrets.CORE_REPO_TOKEN }}
      
      - name: Node.jsのセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: 依存関係のインストール
        run: |
          # note-auto-coreの依存関係をインストール
          cd note-auto-core && npm install
          cd ..
          # ローカルパッケージを直接参照してインストール
          npm install ./note-auto-core
      
      - name: Chromiumのインストール
        run: |
          npx puppeteer browsers install chrome
      
      - name: ニュース記事を生成・投稿
        env:
          NOTE_EMAIL: ${{ secrets.NOTE_EMAIL }}
          NOTE_PASSWORD: ${{ secrets.NOTE_PASSWORD }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          node scripts/generateYNewsArticle.js --bg
      
      - name: エラー時の通知（オプション）
        if: failure()
        run: |
          echo "ニュース記事の生成・投稿に失敗しました"
          # Slack通知などを追加することもできます

